<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="X-UA-Compatible" content="ie=edge" />
    <title>Olah Gambar Cakep</title>

    <link
      href="https://unpkg.com/material-components-web@latest/dist/material-components-web.min.css"
      rel="stylesheet"
    />
    <script src="https://unpkg.com/material-components-web@latest/dist/material-components-web.min.js"></script>
    <link
      rel="stylesheet"
      href="https://fonts.googleapis.com/icon?family=Material+Icons"
    />

    <style>
      .log_view_container {
        margin-top: 24px;
        overflow-y: scroll;
        background-color: black;
        color: green;
        height: 100px;
        max-height: 100px;
        padding: 12px;
      }

      .foto-card__media {
        background-image: url("output/e99808fd-9cfb-45b0-b746-ffcf600ab543_exp2jpg.png");
      }

      .mdc-card {
        margin-top: 44px;
        width: 100%;
        max-width: 500px;
        height: auto;
      }
    </style>
  </head>

  <body>
    <div>
      <input
        class="mdc-button mdc-button--raised mdc-card__action"
        type="file"
        id="foto"
        name="foto"
      />
      <input
        class="mdc-button mdc-button--raised mdc-card__action"
        type="button"
        onclick="upload()"
        value="Upload!"
      />
    </div>
    <div class="log_view_container" id="log_view_container">
      <code id="log_view">
        Log pemrosesan gambar keluar disini. Pilih file gambar dan upload untuk
        melihat hasil.
      </code>
    </div>

    <div class="gambar_hasil_container" id="gambar_hasil_container"></div>

    <script src="socket.io/socket.io.js"></script>
    <script>
      let socketId = "";
      const socket = io();

      socket.on("connect", () => {
        socketId = socket.id;
      });

      const log_view_container = document.getElementById("log_view_container");
      const log_view = document.getElementById("log_view");
      socket.on("event", function (msg) {
        log_view.innerText += msg.data;
        log_view_container.scrollTop = log_view_container.scrollHeight;
      });

      const gambar_hasil_container = document.getElementById(
        "gambar_hasil_container"
      );
      socket.on("hasil", function (msg) {
        console.log(msg);
        gambar_hasil_container.innerHTML = `
        <div class="mdc-card">
          <div
            class="foto-card__media mdc-card__media mdc-card__media--square"
          ></div>
          <div class="mdc-card__actions">
            <div class="mdc-card__action-buttons">
              <button
                class="mdc-button--raised mdc-button mdc-card__action mdc-card__action--button"
                onclick="open_new_tab('${msg.url.png}')"
              >
                <div class="mdc-button__ripple"></div>
                <i class="material-icons mdc-button__icon" aria-hidden="true"
                  >download</i
                >
                <span class="mdc-button__label">PNG</span>
              </button>
              <button
                class="mdc-button mdc-button--raised mdc-card__action mdc-card__action--button"
                onclick="open_new_tab('${msg.url.svg}')"
              >
                <div class="mdc-button__ripple"></div>
                <i class="material-icons mdc-button__icon" aria-hidden="true"
                  >download</i
                >
                <span class="mdc-button__label">SVG</span>
              </button>
            </div>
          </div>
        </div>
        `;
        console.log(gambar_hasil_container.innerHTML);
      });

      const upload = () => {
        const files = document.getElementById("foto").files;
        const formData = new FormData();
        formData.append("foto", files[0]);

        fetch(`/${socketId}`, {
          method: "POST",
          body: formData,
        })
          .then((response) => response.json())
          .then((data) => {
            console.log(data);
          })
          .catch((error) => {
            console.error(error);
          });
      };

      const open_new_tab = (url) => {
        const open_link = window.open("", "_blank");
        open_link.location = url;
      };

      const selector =
        ".mdc-button, .mdc-icon-button, .mdc-card__primary-action";
      const ripples = [].map.call(
        document.querySelectorAll(selector),
        function (el) {
          return new mdc.ripple.MDCRipple(el);
        }
      );
    </script>
  </body>
</html>
